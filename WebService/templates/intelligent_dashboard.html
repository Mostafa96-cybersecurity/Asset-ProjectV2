<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 Intelligent Asset Management System</title>
    
    <!-- Modern CSS Framework -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --dark-gradient: linear-gradient(135deg, #434343 0%, #000000 100%);
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .navbar {
            background: var(--primary-gradient) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }

        .stats-card {
            background: var(--primary-gradient);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .btn-modern {
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: all 0.5s ease;
        }

        .btn-modern:hover::before {
            left: 100%;
        }

        .btn-primary-modern {
            background: var(--primary-gradient);
        }

        .btn-success-modern {
            background: var(--success-gradient);
        }

        .btn-warning-modern {
            background: var(--warning-gradient);
        }

        .btn-info-modern {
            background: var(--info-gradient);
        }

        .table-container {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .dataTables_wrapper .dataTables_filter input {
            border-radius: 25px;
            padding: 8px 20px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .dataTables_wrapper .dataTables_filter input:focus {
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-online {
            background: var(--success-gradient);
            color: white;
            animation: pulse-online 2s infinite;
        }

        .status-offline {
            background: var(--warning-gradient);
            color: white;
        }

        .status-unknown {
            background: var(--dark-gradient);
            color: white;
        }

        @keyframes pulse-online {
            0% { box-shadow: 0 0 0 0 rgba(56, 239, 125, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(56, 239, 125, 0); }
            100% { box-shadow: 0 0 0 0 rgba(56, 239, 125, 0); }
        }

        .filter-section {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .department-badge {
            background: var(--info-gradient);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .device-type-badge {
            background: var(--primary-gradient);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal-modern {
            backdrop-filter: blur(10px);
        }

        .modal-modern .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .automation-status {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 1050;
            background: var(--success-gradient);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .real-time-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #00ff00;
            border-radius: 50%;
            animation: blink 1s infinite;
            margin-right: 5px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .table td {
            vertical-align: middle;
            padding: 6px 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        .table th {
            padding: 8px 4px;
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .action-buttons .btn {
            margin-right: 3px;
            margin-bottom: 3px;
            padding: 2px 6px;
            font-size: 0.7rem;
        }

        .quick-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
        }

        .quick-stat {
            text-align: center;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 8px;
            min-width: 100px;
        }

        .quick-stat h3 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .quick-stat small {
            font-size: 0.7rem;
        }

        .compact-table {
            font-size: 0.75rem;
        }

        .compact-table .status-badge {
            padding: 2px 8px;
            font-size: 0.65rem;
        }

        .compact-table .department-badge,
        .compact-table .device-type-badge {
            padding: 2px 6px;
            font-size: 0.65rem;
        }

        .dataTables_wrapper .dataTables_length select,
        .dataTables_wrapper .dataTables_filter input {
            font-size: 0.8rem;
            padding: 4px 8px;
        }

        .card-header h5 {
            font-size: 1rem;
        }

        .filter-section {
            padding: 15px;
        }

        .filter-section .form-label {
            font-size: 0.8rem;
            margin-bottom: 3px;
        }

        .filter-section .form-control,
        .filter-section .form-select {
            font-size: 0.8rem;
            padding: 4px 8px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        /* Device Details Modal Styles */
        .device-details-modal .modal-dialog {
            max-width: 90%;
        }

        .device-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .detail-section {
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid var(--primary-gradient);
        }

        .detail-section h6 {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.8rem;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #666;
            min-width: 120px;
        }

        .detail-value {
            color: #333;
            text-align: right;
            word-break: break-word;
        }

        .json-data {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.7rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .status-unknown { background: #6c757d; }

        /* Compact filter section */
        .filter-section .row {
            align-items: center;
        }

        .filter-section .btn-modern {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .table-container {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .table td {
                font-size: 0.7rem;
                padding: 4px 2px;
                max-width: 80px;
            }
            
            .quick-stat {
                min-width: 80px;
                padding: 8px;
            }
            
            .quick-stat h3 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-microchip me-2"></i>
                🚀 Intelligent Asset Management
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <span class="real-time-indicator"></span>
                    Real-Time Dashboard
                </span>
            </div>
        </div>
    </nav>

    <!-- Automation Status Indicator -->
    <div id="automationStatus" class="automation-status" style="display: none;">
        <i class="fas fa-robot me-2"></i>
        <span id="automationText">Intelligent Automation Active</span>
    </div>

    <div class="container-fluid py-4">
        <!-- Quick Statistics -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="quick-stats">
                    <div class="quick-stat">
                        <h3 id="totalDevices" class="text-primary mb-1">-</h3>
                        <small class="text-muted">Total Assets</small>
                    </div>
                    <div class="quick-stat">
                        <h3 id="onlineDevices" class="text-success mb-1">-</h3>
                        <small class="text-muted">Online</small>
                    </div>
                    <div class="quick-stat">
                        <h3 id="offlineDevices" class="text-danger mb-1">-</h3>
                        <small class="text-muted">Offline</small>
                    </div>
                    <div class="quick-stat">
                        <h3 id="unknownDevices" class="text-warning mb-1">-</h3>
                        <small class="text-muted">Unknown</small>
                    </div>
                    <div class="quick-stat">
                        <h3 id="avgCompleteness" class="text-info mb-1">-</h3>
                        <small class="text-muted">Data Quality</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Filters -->
        <div class="filter-section">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label class="form-label fw-bold">🔍 Smart Search</label>
                    <input type="text" id="globalSearch" class="form-control" placeholder="Search hostname, IP, user...">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">📊 Status</label>
                    <select id="statusFilter" class="form-select">
                        <option value="">All Statuses</option>
                        <option value="online">Online</option>
                        <option value="offline">Offline</option>
                        <option value="unknown">Unknown</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">💻 Device Type</label>
                    <select id="deviceTypeFilter" class="form-select">
                        <option value="">All Types</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">🏢 Department</label>
                    <select id="departmentFilter" class="form-select">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">🖥️ OS Filter</label>
                    <input type="text" id="osFilter" class="form-control" placeholder="Windows, Linux...">
                </div>
                <div class="col-md-1">
                    <button id="clearFilters" class="btn btn-outline-secondary btn-modern w-100">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <button id="refreshData" class="btn btn-primary-modern btn-modern me-2">
                        <i class="fas fa-sync-alt me-1"></i> Refresh Data
                    </button>
                    <button id="exportData" class="btn btn-success-modern btn-modern me-2">
                        <i class="fas fa-download me-1"></i> Export
                    </button>
                    <button id="manageDeptsBtn" class="btn btn-info-modern btn-modern me-2">
                        <i class="fas fa-building me-1"></i> Manage Departments
                    </button>
                    <button id="automationSettings" class="btn btn-warning-modern btn-modern">
                        <i class="fas fa-robot me-1"></i> Automation
                    </button>
                </div>
                <div class="col-md-6 text-end">
                    <small class="text-muted">
                        Last updated: <span id="lastUpdated">Loading...</span>
                    </small>
                </div>
            </div>
        </div>

        <!-- Main Assets Table -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Comprehensive Asset Inventory
                    <span id="loadingIndicator" class="float-end" style="display: none;">
                        <div class="loading-spinner"></div>
                    </span>
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-container">
                    <table id="assetsTable" class="table table-striped table-hover compact-table w-100">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 80px;">Actions</th>
                                <th style="width: 60px;">Status</th>
                                <th style="width: 120px;">Hostname</th>
                                <th style="width: 100px;">IP Address</th>
                                <th style="width: 100px;">Device Type</th>
                                <th style="width: 100px;">Department</th>
                                <th style="width: 120px;">Operating System</th>
                                <th style="width: 100px;">Manufacturer</th>
                                <th style="width: 100px;">Model</th>
                                <th style="width: 150px;">Processor</th>
                                <th style="width: 80px;">Memory</th>
                                <th style="width: 100px;">Storage</th>
                                <th style="width: 100px;">Current User</th>
                                <th style="width: 120px;">MAC Address</th>
                                <th style="width: 80px;">Graphics</th>
                                <th style="width: 80px;">Monitors</th>
                                <th style="width: 80px;">Software</th>
                                <th style="width: 100px;">Antivirus</th>
                                <th style="width: 80px;">Firewall</th>
                                <th style="width: 80px;">Users</th>
                                <th style="width: 100px;">BIOS</th>
                                <th style="width: 80px;">CPU %</th>
                                <th style="width: 80px;">RAM %</th>
                                <th style="width: 80px;">Uptime</th>
                                <th style="width: 100px;">Collection</th>
                                <th style="width: 80px;">Quality</th>
                                <th style="width: 80px;">Match</th>
                                <th style="width: 100px;">Location</th>
                                <th style="width: 80px;">Site</th>
                                <th style="width: 100px;">Cost Center</th>
                                <th style="width: 100px;">Purchase</th>
                                <th style="width: 100px;">Warranty</th>
                                <th style="width: 120px;">Serial</th>
                                <th style="width: 100px;">Asset Tag</th>
                                <th style="width: 120px;">Last Seen</th>
                            </tr>
                        </thead>
                        <tbody id="assetsTableBody">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Device Details Modal -->
    <div class="modal fade device-details-modal" id="deviceDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-desktop me-2"></i>
                        <span id="deviceDetailsTitle">Device Details</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="device-details-grid" id="deviceDetailsContent">
                        <!-- Dynamic content -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="editDeviceFromDetails">
                        <i class="fas fa-edit me-1"></i> Edit Device
                    </button>
                    <button type="button" class="btn btn-warning" id="scanDeviceFromDetails">
                        <i class="fas fa-search me-1"></i> Scan Device
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Department Management Modal -->
    <div class="modal fade modal-modern" id="departmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-building me-2"></i>
                        Department Management
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Create New Department</h6>
                            <form id="newDepartmentForm">
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="deptName" placeholder="Department Name" required>
                                </div>
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="deptLocation" placeholder="Location">
                                </div>
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="deptManager" placeholder="Manager Name">
                                </div>
                                <div class="mb-3">
                                    <input type="email" class="form-control" id="deptEmail" placeholder="Manager Email">
                                </div>
                                <div class="mb-3">
                                    <textarea class="form-control" id="deptDescription" placeholder="Description" rows="3"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary-modern btn-modern">
                                    <i class="fas fa-plus me-1"></i> Create Department
                                </button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <h6>Existing Departments</h6>
                            <div id="departmentsList" class="list-group">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Asset Edit Modal -->
    <div class="modal fade modal-modern" id="editAssetModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>
                        Edit Asset
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editAssetForm">
                        <input type="hidden" id="editAssetId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Device Type</label>
                                    <select class="form-select" id="editDeviceType" required>
                                        <!-- Options loaded dynamically -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Department</label>
                                    <select class="form-select" id="editDepartment" required>
                                        <!-- Options loaded dynamically -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Location</label>
                                    <input type="text" class="form-control" id="editLocation">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Site</label>
                                    <input type="text" class="form-control" id="editSite">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Cost Center</label>
                                    <input type="text" class="form-control" id="editCostCenter">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Purchase Date</label>
                                    <input type="date" class="form-control" id="editPurchaseDate">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Warranty Expiry</label>
                                    <input type="date" class="form-control" id="editWarrantyExpiry">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Current User</label>
                                    <input type="text" class="form-control" id="editCurrentUser">
                                </div>
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success-modern btn-modern">
                                <i class="fas fa-save me-1"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
    $(document).ready(function() {
        // Global variables
        let assetsTable;
        let currentFilters = {};
        let refreshInterval;

        // Initialize dashboard
        initializeDashboard();

        function initializeDashboard() {
            console.log('🚀 Initializing Intelligent Asset Management Dashboard');
            
            // Load initial data
            loadDashboardStats();
            loadDeviceTypes();
            loadDepartments();
            initializeAssetsTable();
            setupEventHandlers();
            checkAutomationStatus();
            
            // Start real-time updates
            startRealTimeUpdates();
            
            console.log('✅ Dashboard initialized successfully');
        }

        function loadDashboardStats() {
            $('#loadingIndicator').show();
            
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    console.log('📊 Dashboard stats loaded:', data);
                    updateQuickStats(data);
                    $('#lastUpdated').text(new Date().toLocaleTimeString());
                })
                .catch(error => {
                    console.error('❌ Error loading stats:', error);
                    showAlert('Error loading dashboard statistics', 'danger');
                })
                .finally(() => {
                    $('#loadingIndicator').hide();
                });
        }

        function updateQuickStats(data) {
            $('#totalDevices').text(data.total_devices || 0);
            $('#onlineDevices').text(data.device_status?.online || 0);
            $('#offlineDevices').text(data.device_status?.offline || 0);
            $('#unknownDevices').text(data.unknown_devices || 0);
            $('#avgCompleteness').text((data.avg_data_completeness || 0) + '%');
        }

        function loadDeviceTypes() {
            fetch('/api/device-types')
                .then(response => response.json())
                .then(types => {
                    const select = $('#deviceTypeFilter');
                    const editSelect = $('#editDeviceType');
                    
                    types.forEach(type => {
                        select.append(`<option value="${type}">${type}</option>`);
                        editSelect.append(`<option value="${type}">${type}</option>`);
                    });
                })
                .catch(error => console.error('❌ Error loading device types:', error));
        }

        function loadDepartments() {
            fetch('/api/departments')
                .then(response => response.json())
                .then(departments => {
                    const select = $('#departmentFilter');
                    const editSelect = $('#editDepartment');
                    const list = $('#departmentsList');
                    
                    // Clear existing options
                    select.find('option:not(:first)').remove();
                    editSelect.empty();
                    list.empty();
                    
                    departments.forEach(dept => {
                        select.append(`<option value="${dept.name}">${dept.name} (${dept.device_count})</option>`);
                        editSelect.append(`<option value="${dept.name}">${dept.name}</option>`);
                        
                        list.append(`
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${dept.name}</strong>
                                    <br><small class="text-muted">${dept.location || 'No location'}</small>
                                    <br><small class="text-muted">Manager: ${dept.manager_name || 'Not assigned'}</small>
                                </div>
                                <span class="badge bg-primary rounded-pill">${dept.device_count}</span>
                            </div>
                        `);
                    });
                })
                .catch(error => console.error('❌ Error loading departments:', error));
        }

        function initializeAssetsTable() {
            assetsTable = $('#assetsTable').DataTable({
                processing: true,
                serverSide: false,
                responsive: true,
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                order: [[2, 'asc']], // Sort by hostname
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
                language: {
                    search: "🔍 Search:",
                    lengthMenu: "Show _MENU_ assets",
                    info: "Showing _START_ to _END_ of _TOTAL_ assets",
                    emptyTable: "No assets found",
                    processing: '<div class="loading-spinner"></div> Loading assets...'
                },
                columns: [
                    { data: null, orderable: false, className: 'text-center', width: '80px' },
                    { data: 'device_status', className: 'text-center', width: '60px' },
                    { data: 'hostname', className: 'fw-bold', width: '120px' },
                    { data: 'ip_address', width: '100px' },
                    { data: 'device_type', width: '100px' },
                    { data: 'assigned_department', width: '100px' },
                    { data: 'operating_system', width: '120px' },
                    { data: 'system_manufacturer', width: '100px' },
                    { data: 'system_model', width: '100px' },
                    { data: 'processor_name', width: '150px' },
                    { data: 'total_physical_memory_gb', width: '80px' },
                    { data: 'storage_summary', width: '100px' },
                    { data: 'current_user', width: '100px' },
                    { data: 'mac_address', width: '120px' },
                    { data: 'graphics_cards', width: '80px' },
                    { data: 'connected_monitors', width: '80px' },
                    { data: 'installed_software', width: '80px' },
                    { data: 'antivirus_software', width: '100px' },
                    { data: 'firewall_status', width: '80px' },
                    { data: 'user_profiles', width: '80px' },
                    { data: 'bios_version', width: '100px' },
                    { data: 'cpu_usage_percent', width: '80px' },
                    { data: 'memory_usage_percent', width: '80px' },
                    { data: 'uptime_formatted', width: '80px' },
                    { data: 'collection_method', width: '100px' },
                    { data: 'data_completeness_score', width: '80px' },
                    { data: 'hostname_mismatch_status', width: '80px' },
                    { data: 'location', width: '100px' },
                    { data: 'site', width: '80px' },
                    { data: 'cost_center', width: '100px' },
                    { data: 'purchase_date', width: '100px' },
                    { data: 'warranty_expiry', width: '100px' },
                    { data: 'serial_number', width: '120px' },
                    { data: 'asset_tag', width: '100px' },
                    { data: 'last_seen', width: '120px' }
                ],
                columnDefs: [
                    {
                        targets: 0,
                        render: function(data, type, row) {
                            return `
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-info view-details" data-id="${row.id}" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-primary edit-asset" data-id="${row.id}" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning scan-device" data-id="${row.id}" title="Scan">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            `;
                        }
                    },
                    {
                        targets: 1,
                        render: function(data, type, row) {
                            const statusClass = `status-${data}`;
                            const icon = data === 'online' ? 'fa-circle' : data === 'offline' ? 'fa-times-circle' : 'fa-question-circle';
                            return `<span class="status-badge ${statusClass}"><i class="fas ${icon} me-1"></i>${data}</span>`;
                        }
                    },
                    {
                        targets: 2,
                        render: function(data, type, row) {
                            return `<span title="${data || 'Unknown'}">${data || 'Unknown'}</span>`;
                        }
                    },
                    {
                        targets: 4,
                        render: function(data, type, row) {
                            return data ? `<span class="device-type-badge" title="${data}">${data}</span>` : '<span class="text-muted">Unknown</span>';
                        }
                    },
                    {
                        targets: 5,
                        render: function(data, type, row) {
                            return data ? `<span class="department-badge" title="${data}">${data}</span>` : '<span class="text-muted">Unassigned</span>';
                        }
                    },
                    {
                        targets: [6, 7, 8, 9, 11, 12, 20],
                        render: function(data, type, row) {
                            const displayText = data || '-';
                            return `<span title="${displayText}">${displayText.length > 15 ? displayText.substring(0, 15) + '...' : displayText}</span>`;
                        }
                    },
                    {
                        targets: [10],
                        render: function(data, type, row) {
                            return data ? `${data} GB` : '-';
                        }
                    },
                    {
                        targets: [21, 22],
                        render: function(data, type, row) {
                            return data ? `${data}%` : '-';
                        }
                    },
                    {
                        targets: [25],
                        render: function(data, type, row) {
                            return data ? `${data}%` : '-';
                        }
                    },
                    {
                        targets: [14, 16, 19],
                        render: function(data, type, row) {
                            if (Array.isArray(data)) {
                                return `<span title="${data.length} items">${data.length}</span>`;
                            }
                            return data ? `<span title="${data}">Yes</span>` : 'No';
                        }
                    },
                    {
                        targets: [13],
                        render: function(data, type, row) {
                            return data ? `<span title="${data}">${data.substring(0, 12)}...</span>` : '-';
                        }
                    },
                    {
                        targets: [30, 31],
                        render: function(data, type, row) {
                            return data ? new Date(data).toLocaleDateString() : '-';
                        }
                    },
                    {
                        targets: [34],
                        render: function(data, type, row) {
                            return data ? new Date(data).toLocaleString() : '-';
                        }
                    }
                ]
            });

            loadAssetsData();
        }

        function loadAssetsData() {
            $('#loadingIndicator').show();
            
            // Build query parameters
            const params = new URLSearchParams({
                page: 1,
                per_page: 1000, // Load all for client-side processing
                search: currentFilters.search || '',
                ...currentFilters
            });

            fetch(`/api/assets?${params}`)
                .then(response => response.json())
                .then(data => {
                    console.log('📋 Assets data loaded:', data.assets.length, 'assets');
                    
                    // Clear and reload table
                    assetsTable.clear();
                    assetsTable.rows.add(data.assets);
                    assetsTable.draw();
                    
                    $('#lastUpdated').text(new Date().toLocaleTimeString());
                })
                .catch(error => {
                    console.error('❌ Error loading assets:', error);
                    showAlert('Error loading assets data', 'danger');
                })
                .finally(() => {
                    $('#loadingIndicator').hide();
                });
        }

        function setupEventHandlers() {
            // Search and filters
            $('#globalSearch').on('input', debounce(function() {
                currentFilters.search = $(this).val();
                loadAssetsData();
            }, 500));

            $('#statusFilter, #deviceTypeFilter, #departmentFilter').on('change', function() {
                const filterType = $(this).attr('id').replace('Filter', '');
                currentFilters[filterType === 'deviceType' ? 'device_type' : filterType === 'status' ? 'status' : 'department'] = $(this).val();
                loadAssetsData();
            });

            $('#osFilter').on('input', debounce(function() {
                currentFilters.operating_system = $(this).val();
                loadAssetsData();
            }, 500));

            // Clear filters
            $('#clearFilters').on('click', function() {
                currentFilters = {};
                $('#globalSearch, #osFilter').val('');
                $('#statusFilter, #deviceTypeFilter, #departmentFilter').val('');
                loadAssetsData();
            });

            // Refresh data
            $('#refreshData').on('click', function() {
                loadDashboardStats();
                loadAssetsData();
                showAlert('Data refreshed successfully', 'success');
            });

            // Export data
            $('#exportData').on('click', function() {
                showAlert('Export functionality available via DataTable buttons', 'info');
            });

            // Manage departments
            $('#manageDeptsBtn').on('click', function() {
                loadDepartments();
                $('#departmentModal').modal('show');
            });

            // Department creation
            $('#newDepartmentForm').on('submit', function(e) {
                e.preventDefault();
                createDepartment();
            });

            // Asset actions
            $(document).on('click', '.view-details', function() {
                const assetId = $(this).data('id');
                openDeviceDetailsModal(assetId);
            });

            $(document).on('click', '.edit-asset', function() {
                const assetId = $(this).data('id');
                openEditAssetModal(assetId);
            });

            $(document).on('click', '.scan-device', function() {
                const assetId = $(this).data('id');
                scanDevice(assetId);
            });

            // Device details modal actions
            $('#editDeviceFromDetails').on('click', function() {
                const assetId = $('#deviceDetailsModal').data('asset-id');
                $('#deviceDetailsModal').modal('hide');
                setTimeout(() => openEditAssetModal(assetId), 300);
            });

            $('#scanDeviceFromDetails').on('click', function() {
                const assetId = $('#deviceDetailsModal').data('asset-id');
                scanDevice(assetId);
            });

            // Edit asset form
            $('#editAssetForm').on('submit', function(e) {
                e.preventDefault();
                saveAssetChanges();
            });

            // Automation settings
            $('#automationSettings').on('click', function() {
                showAlert('Automation is running in the background. Check console for details.', 'info');
                checkAutomationStatus();
            });
        }

        function openDeviceDetailsModal(assetId) {
            // Find asset data from table
            const rowData = assetsTable.rows().data().toArray().find(asset => asset.id == assetId);
            
            if (rowData) {
                $('#deviceDetailsModal').data('asset-id', assetId);
                $('#deviceDetailsTitle').text(`${rowData.hostname || 'Unknown'} (${rowData.ip_address || 'No IP'})`);
                
                // Build comprehensive device details
                const detailsHtml = buildDeviceDetailsContent(rowData);
                $('#deviceDetailsContent').html(detailsHtml);
                
                $('#deviceDetailsModal').modal('show');
            }
        }

        function buildDeviceDetailsContent(device) {
            return `
                <!-- Identity Section -->
                <div class="detail-section">
                    <h6><i class="fas fa-id-card me-2"></i>Device Identity</h6>
                    <div class="detail-item">
                        <span class="detail-label">Hostname:</span>
                        <span class="detail-value">${device.hostname || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Computer Name:</span>
                        <span class="detail-value">${device.computer_name || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">IP Address:</span>
                        <span class="detail-value">${device.ip_address || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">MAC Address:</span>
                        <span class="detail-value">${device.mac_address || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value">
                            <span class="status-indicator status-${device.device_status}"></span>
                            ${device.device_status || 'Unknown'}
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Device Type:</span>
                        <span class="detail-value">${device.device_type || 'Unknown'}</span>
                    </div>
                </div>

                <!-- System Information -->
                <div class="detail-section">
                    <h6><i class="fas fa-desktop me-2"></i>System Information</h6>
                    <div class="detail-item">
                        <span class="detail-label">Operating System:</span>
                        <span class="detail-value">${device.operating_system || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">OS Version:</span>
                        <span class="detail-value">${device.os_version || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">OS Build:</span>
                        <span class="detail-value">${device.os_build || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Manufacturer:</span>
                        <span class="detail-value">${device.system_manufacturer || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Model:</span>
                        <span class="detail-value">${device.system_model || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">BIOS Version:</span>
                        <span class="detail-value">${device.bios_version || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Serial Number:</span>
                        <span class="detail-value">${device.serial_number || 'Unknown'}</span>
                    </div>
                </div>

                <!-- Hardware Specifications -->
                <div class="detail-section">
                    <h6><i class="fas fa-microchip me-2"></i>Hardware Specifications</h6>
                    <div class="detail-item">
                        <span class="detail-label">Processor:</span>
                        <span class="detail-value">${device.processor_name || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">CPU Cores:</span>
                        <span class="detail-value">${device.processor_cores || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Logical Cores:</span>
                        <span class="detail-value">${device.processor_logical_cores || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Total Memory:</span>
                        <span class="detail-value">${device.total_physical_memory_gb ? device.total_physical_memory_gb + ' GB' : 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Available Memory:</span>
                        <span class="detail-value">${device.available_memory_gb ? device.available_memory_gb + ' GB' : 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Storage Summary:</span>
                        <span class="detail-value">${device.storage_summary || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Total Storage:</span>
                        <span class="detail-value">${device.total_storage_gb ? device.total_storage_gb + ' GB' : 'Unknown'}</span>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="detail-section">
                    <h6><i class="fas fa-chart-line me-2"></i>Performance Metrics</h6>
                    <div class="detail-item">
                        <span class="detail-label">CPU Usage:</span>
                        <span class="detail-value">${device.cpu_usage_percent ? device.cpu_usage_percent + '%' : 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Memory Usage:</span>
                        <span class="detail-value">${device.memory_usage_percent ? device.memory_usage_percent + '%' : 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">System Uptime:</span>
                        <span class="detail-value">${device.uptime_formatted || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Data Quality:</span>
                        <span class="detail-value">${device.data_completeness_score ? device.data_completeness_score + '%' : 'Unknown'}</span>
                    </div>
                </div>

                <!-- User Information -->
                <div class="detail-section">
                    <h6><i class="fas fa-users me-2"></i>User Information</h6>
                    <div class="detail-item">
                        <span class="detail-label">Current User:</span>
                        <span class="detail-value">${device.current_user || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Last Logged Users:</span>
                        <span class="detail-value">${device.last_logged_users || 'Unknown'}</span>
                    </div>
                    ${device.user_profiles ? `
                    <div class="detail-item">
                        <span class="detail-label">User Profiles:</span>
                        <span class="detail-value">
                            <div class="json-data">${formatJsonData(device.user_profiles)}</div>
                        </span>
                    </div>
                    ` : ''}
                </div>

                <!-- Network Information -->
                <div class="detail-section">
                    <h6><i class="fas fa-network-wired me-2"></i>Network Information</h6>
                    <div class="detail-item">
                        <span class="detail-label">Primary IP:</span>
                        <span class="detail-value">${device.ip_address || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">MAC Address:</span>
                        <span class="detail-value">${device.mac_address || 'Unknown'}</span>
                    </div>
                    ${device.network_adapters ? `
                    <div class="detail-item">
                        <span class="detail-label">Network Adapters:</span>
                        <span class="detail-value">
                            <div class="json-data">${formatJsonData(device.network_adapters)}</div>
                        </span>
                    </div>
                    ` : ''}
                </div>

                <!-- Graphics & Display -->
                <div class="detail-section">
                    <h6><i class="fas fa-tv me-2"></i>Graphics & Display</h6>
                    <div class="detail-item">
                        <span class="detail-label">Connected Monitors:</span>
                        <span class="detail-value">${device.connected_monitors || '0'}</span>
                    </div>
                    ${device.graphics_cards ? `
                    <div class="detail-item">
                        <span class="detail-label">Graphics Cards:</span>
                        <span class="detail-value">
                            <div class="json-data">${formatJsonData(device.graphics_cards)}</div>
                        </span>
                    </div>
                    ` : ''}
                </div>

                <!-- Software Information -->
                <div class="detail-section">
                    <h6><i class="fas fa-laptop-code me-2"></i>Software Information</h6>
                    <div class="detail-item">
                        <span class="detail-label">Antivirus:</span>
                        <span class="detail-value">${device.antivirus_software || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Firewall Status:</span>
                        <span class="detail-value">${device.firewall_status || 'Unknown'}</span>
                    </div>
                    ${device.installed_software ? `
                    <div class="detail-item">
                        <span class="detail-label">Installed Software:</span>
                        <span class="detail-value">
                            <div class="json-data">${formatJsonData(device.installed_software)}</div>
                        </span>
                    </div>
                    ` : ''}
                </div>

                <!-- Management Information -->
                <div class="detail-section">
                    <h6><i class="fas fa-building me-2"></i>Management Information</h6>
                    <div class="detail-item">
                        <span class="detail-label">Department:</span>
                        <span class="detail-value">${device.assigned_department || 'Unassigned'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Location:</span>
                        <span class="detail-value">${device.location || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Site:</span>
                        <span class="detail-value">${device.site || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Cost Center:</span>
                        <span class="detail-value">${device.cost_center || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Asset Tag:</span>
                        <span class="detail-value">${device.asset_tag || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Purchase Date:</span>
                        <span class="detail-value">${device.purchase_date ? new Date(device.purchase_date).toLocaleDateString() : 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Warranty Expiry:</span>
                        <span class="detail-value">${device.warranty_expiry ? new Date(device.warranty_expiry).toLocaleDateString() : 'Unknown'}</span>
                    </div>
                </div>

                <!-- Collection Information -->
                <div class="detail-section">
                    <h6><i class="fas fa-database me-2"></i>Collection Information</h6>
                    <div class="detail-item">
                        <span class="detail-label">Collection Method:</span>
                        <span class="detail-value">${device.collection_method || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Hostname Mismatch:</span>
                        <span class="detail-value">${device.hostname_mismatch_status || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Last Seen:</span>
                        <span class="detail-value">${device.last_seen ? new Date(device.last_seen).toLocaleString() : 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Created:</span>
                        <span class="detail-value">${device.created_at ? new Date(device.created_at).toLocaleString() : 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Updated:</span>
                        <span class="detail-value">${device.updated_at ? new Date(device.updated_at).toLocaleString() : 'Unknown'}</span>
                    </div>
                </div>
            `;
        }

        function formatJsonData(data) {
            if (Array.isArray(data)) {
                return data.map((item, index) => `${index + 1}. ${typeof item === 'object' ? JSON.stringify(item, null, 2) : item}`).join('\n');
            } else if (typeof data === 'object') {
                return JSON.stringify(data, null, 2);
            }
            return data || 'No data available';
        }

        function createDepartment() {
            const data = {
                name: $('#deptName').val(),
                description: $('#deptDescription').val(),
                location: $('#deptLocation').val(),
                manager_name: $('#deptManager').val(),
                manager_email: $('#deptEmail').val()
            };

            fetch('/api/departments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert('Department created successfully', 'success');
                    $('#newDepartmentForm')[0].reset();
                    loadDepartments();
                } else {
                    showAlert(result.error, 'danger');
                }
            })
            .catch(error => {
                console.error('❌ Error creating department:', error);
                showAlert('Error creating department', 'danger');
            });
        }

        function openEditAssetModal(assetId) {
            // Find asset data from table
            const rowData = assetsTable.rows().data().toArray().find(asset => asset.id == assetId);
            
            if (rowData) {
                $('#editAssetId').val(assetId);
                $('#editDeviceType').val(rowData.device_type);
                $('#editDepartment').val(rowData.assigned_department);
                $('#editLocation').val(rowData.location);
                $('#editSite').val(rowData.site);
                $('#editCostCenter').val(rowData.cost_center);
                $('#editPurchaseDate').val(rowData.purchase_date);
                $('#editWarrantyExpiry').val(rowData.warranty_expiry);
                $('#editCurrentUser').val(rowData.current_user);
                
                $('#editAssetModal').modal('show');
            }
        }

        function saveAssetChanges() {
            const assetId = $('#editAssetId').val();
            const updates = {
                device_type: $('#editDeviceType').val(),
                assigned_department: $('#editDepartment').val(),
                location: $('#editLocation').val(),
                site: $('#editSite').val(),
                cost_center: $('#editCostCenter').val(),
                purchase_date: $('#editPurchaseDate').val(),
                warranty_expiry: $('#editWarrantyExpiry').val(),
                current_user: $('#editCurrentUser').val()
            };

            fetch(`/api/assets/${assetId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert('Asset updated successfully', 'success');
                    $('#editAssetModal').modal('hide');
                    loadAssetsData(); // Refresh table
                } else {
                    showAlert(result.error, 'danger');
                }
            })
            .catch(error => {
                console.error('❌ Error updating asset:', error);
                showAlert('Error updating asset', 'danger');
            });
        }

        function scanDevice(assetId) {
            const button = $(`.scan-device[data-id="${assetId}"]`);
            const originalHtml = button.html();
            
            button.html('<div class="loading-spinner"></div>').prop('disabled', true);

            fetch(`/api/scan-device/${assetId}`, { method: 'POST' })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showAlert(`Device classified as: ${result.device_type}`, 'success');
                        loadAssetsData(); // Refresh table
                    } else {
                        showAlert(result.error, 'warning');
                    }
                })
                .catch(error => {
                    console.error('❌ Error scanning device:', error);
                    showAlert('Error scanning device', 'danger');
                })
                .finally(() => {
                    button.html(originalHtml).prop('disabled', false);
                });
        }

        function checkAutomationStatus() {
            fetch('/api/automation/status')
                .then(response => response.json())
                .then(data => {
                    if (data.automation_running) {
                        $('#automationStatus').show();
                        $('#automationText').text(
                            data.nmap_available ? 
                            'Intelligent Automation Active (NMAP Enabled)' : 
                            'Intelligent Automation Active'
                        );
                    }
                })
                .catch(error => console.error('❌ Error checking automation:', error));
        }

        function startRealTimeUpdates() {
            // Update dashboard stats every 30 seconds
            refreshInterval = setInterval(() => {
                loadDashboardStats();
            }, 30000);

            // Full data refresh every 5 minutes
            setInterval(() => {
                loadAssetsData();
            }, 300000);
        }

        function showAlert(message, type) {
            const alert = $(`
                <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            $('body').append(alert);
            
            setTimeout(() => {
                alert.alert('close');
            }, 5000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Cleanup on page unload
        $(window).on('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    });
    </script>
</body>
</html>